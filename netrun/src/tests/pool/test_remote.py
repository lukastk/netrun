# AUTOGENERATED! DO NOT EDIT! File to edit: pts/tests/03_pool/test_remote.pct.py

__all__ = ['pytestmark', 'test_broadcast', 'test_client_creation', 'test_compute_workers', 'test_connect_and_create_pool', 'test_invalid_worker_id', 'test_multiple_workers', 'test_recv_timeout', 'test_register_worker', 'test_send_before_create_raises', 'test_send_recv', 'test_server_creation', 'test_try_recv_empty', 'test_try_recv_with_message', 'test_unknown_worker_raises']

# %% pts/tests/03_pool/test_remote.pct.py 2
import pytest
import asyncio

# Check if websockets is available
try:
    import websockets
    HAS_WEBSOCKETS = True
except ImportError:
    HAS_WEBSOCKETS = False

pytestmark = pytest.mark.skipif(not HAS_WEBSOCKETS, reason="websockets not installed")

# %% pts/tests/03_pool/test_remote.pct.py 3
from netrun.rpc.base import ChannelClosed, RecvTimeout
from netrun.pool.base import (
    WorkerMessage,
    PoolNotStarted,
    PoolError,
)
from netrun.pool.remote import RemotePoolServer, RemotePoolClient

# %% pts/tests/03_pool/test_remote.pct.py 5
from .workers import echo_worker, compute_worker

# %% pts/tests/03_pool/test_remote.pct.py 7
def test_server_creation():
    """Test creating a RemotePoolServer."""
    server = RemotePoolServer()
    assert server.registered_workers == []

# %% pts/tests/03_pool/test_remote.pct.py 9
def test_register_worker():
    """Test registering workers on server."""
    server = RemotePoolServer()
    server.register_worker("echo", echo_worker)
    server.register_worker("compute", compute_worker)

    assert "echo" in server.registered_workers
    assert "compute" in server.registered_workers
    assert len(server.registered_workers) == 2

# %% pts/tests/03_pool/test_remote.pct.py 12
def test_client_creation():
    """Test creating a RemotePoolClient."""
    client = RemotePoolClient("ws://localhost:8080")
    assert client.num_workers == 0
    assert not client.is_running

# %% pts/tests/03_pool/test_remote.pct.py 15
@pytest.mark.asyncio
async def test_connect_and_create_pool():
    """Test connecting client and creating a pool."""
    server = RemotePoolServer()
    server.register_worker("echo", echo_worker)

    async with server.serve_background("127.0.0.1", 19001):
        async with RemotePoolClient("ws://127.0.0.1:19001") as client:
            await client.create_pool("echo", num_processes=1, threads_per_process=1)

            assert client.is_running
            assert client.num_workers == 1
            assert client.num_processes == 1
            assert client.threads_per_process == 1

# %% pts/tests/03_pool/test_remote.pct.py 17
@pytest.mark.asyncio
async def test_send_recv():
    """Test sending and receiving messages."""
    server = RemotePoolServer()
    server.register_worker("echo", echo_worker)

    async with server.serve_background("127.0.0.1", 19002):
        async with RemotePoolClient("ws://127.0.0.1:19002") as client:
            await client.create_pool("echo", num_processes=1, threads_per_process=1)

            await client.send(worker_id=0, key="test", data="hello")
            msg = await client.recv(timeout=10.0)

            assert msg.worker_id == 0
            assert msg.key == "echo:test"
            assert msg.data == {"worker_id": 0, "data": "hello"}

# %% pts/tests/03_pool/test_remote.pct.py 19
@pytest.mark.asyncio
async def test_multiple_workers():
    """Test with multiple workers."""
    server = RemotePoolServer()
    server.register_worker("echo", echo_worker)

    async with server.serve_background("127.0.0.1", 19003):
        async with RemotePoolClient("ws://127.0.0.1:19003") as client:
            await client.create_pool("echo", num_processes=2, threads_per_process=2)

            assert client.num_workers == 4

            # Send to each worker
            for i in range(4):
                await client.send(worker_id=i, key="ping", data=i)

            # Receive all responses
            responses = []
            for _ in range(4):
                msg = await client.recv(timeout=10.0)
                responses.append(msg)

            assert len(responses) == 4
            worker_ids = {msg.worker_id for msg in responses}
            assert worker_ids == {0, 1, 2, 3}

# %% pts/tests/03_pool/test_remote.pct.py 22
@pytest.mark.asyncio
async def test_try_recv_empty():
    """Test try_recv when no messages pending."""
    server = RemotePoolServer()
    server.register_worker("echo", echo_worker)

    async with server.serve_background("127.0.0.1", 19004):
        async with RemotePoolClient("ws://127.0.0.1:19004") as client:
            await client.create_pool("echo", num_processes=1)

            result = await client.try_recv()
            assert result is None

# %% pts/tests/03_pool/test_remote.pct.py 24
@pytest.mark.asyncio
async def test_try_recv_with_message():
    """Test try_recv with pending message."""
    server = RemotePoolServer()
    server.register_worker("echo", echo_worker)

    async with server.serve_background("127.0.0.1", 19005):
        async with RemotePoolClient("ws://127.0.0.1:19005") as client:
            await client.create_pool("echo", num_processes=1)

            await client.send(worker_id=0, key="test", data="data")
            await asyncio.sleep(0.5)  # Let message arrive

            result = await client.try_recv()
            assert result is not None
            assert result.key == "echo:test"

# %% pts/tests/03_pool/test_remote.pct.py 27
@pytest.mark.asyncio
async def test_broadcast():
    """Test broadcasting to all workers."""
    server = RemotePoolServer()
    server.register_worker("echo", echo_worker)

    async with server.serve_background("127.0.0.1", 19006):
        async with RemotePoolClient("ws://127.0.0.1:19006") as client:
            await client.create_pool("echo", num_processes=2, threads_per_process=1)

            await client.broadcast("config", {"setting": "value"})

            responses = []
            for _ in range(client.num_workers):
                msg = await client.recv(timeout=10.0)
                responses.append(msg)

            assert len(responses) == 2
            worker_ids = {msg.worker_id for msg in responses}
            assert worker_ids == {0, 1}

# %% pts/tests/03_pool/test_remote.pct.py 30
@pytest.mark.asyncio
async def test_recv_timeout():
    """Test recv timeout."""
    server = RemotePoolServer()
    server.register_worker("echo", echo_worker)

    async with server.serve_background("127.0.0.1", 19007):
        async with RemotePoolClient("ws://127.0.0.1:19007") as client:
            await client.create_pool("echo", num_processes=1)

            with pytest.raises(RecvTimeout):
                await client.recv(timeout=0.5)

# %% pts/tests/03_pool/test_remote.pct.py 33
@pytest.mark.asyncio
async def test_unknown_worker_raises():
    """Test that requesting unknown worker raises PoolError."""
    server = RemotePoolServer()
    server.register_worker("echo", echo_worker)

    async with server.serve_background("127.0.0.1", 19008):
        async with RemotePoolClient("ws://127.0.0.1:19008") as client:
            with pytest.raises(PoolError):
                await client.create_pool("nonexistent", num_processes=1)

# %% pts/tests/03_pool/test_remote.pct.py 35
@pytest.mark.asyncio
async def test_send_before_create_raises():
    """Test that sending before create_pool raises PoolNotStarted."""
    server = RemotePoolServer()
    server.register_worker("echo", echo_worker)

    async with server.serve_background("127.0.0.1", 19009):
        async with RemotePoolClient("ws://127.0.0.1:19009") as client:
            with pytest.raises(PoolNotStarted):
                await client.send(worker_id=0, key="test", data="data")

# %% pts/tests/03_pool/test_remote.pct.py 37
@pytest.mark.asyncio
async def test_invalid_worker_id():
    """Test that invalid worker_id raises ValueError."""
    server = RemotePoolServer()
    server.register_worker("echo", echo_worker)

    async with server.serve_background("127.0.0.1", 19010):
        async with RemotePoolClient("ws://127.0.0.1:19010") as client:
            await client.create_pool("echo", num_processes=1, threads_per_process=1)

            with pytest.raises(ValueError):
                await client.send(worker_id=-1, key="test", data="data")

            with pytest.raises(ValueError):
                await client.send(worker_id=1, key="test", data="data")

# %% pts/tests/03_pool/test_remote.pct.py 40
@pytest.mark.asyncio
async def test_compute_workers():
    """Test compute workers with actual computation."""
    server = RemotePoolServer()
    server.register_worker("compute", compute_worker)

    async with server.serve_background("127.0.0.1", 19011):
        async with RemotePoolClient("ws://127.0.0.1:19011") as client:
            await client.create_pool("compute", num_processes=2, threads_per_process=1)

            await client.send(worker_id=0, key="square", data=7)
            await client.send(worker_id=1, key="double", data=21)

            results = []
            for _ in range(2):
                msg = await client.recv(timeout=10.0)
                results.append((msg.worker_id, msg.data))

            results.sort()  # Sort by worker_id
            assert results == [(0, 49), (1, 42)]
