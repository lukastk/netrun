# AUTOGENERATED! DO NOT EDIT! File to edit: nbs/netrun/01_iutils/01_hashing.ipynb

__all__ = ['HashMethod', 'adler32', 'blake2b', 'crc32', 'hash', 'sha256', 'xxh64']

# %% nbs/netrun/01_iutils/01_hashing.ipynb 2
from typing import Any

import pickle
import pickletools
import zlib
import binascii
import hashlib
import struct
import xxhash
import json
from enum import Enum

# %% nbs/netrun/01_iutils/01_hashing.ipynb 4
def _preprocess_data(data: Any, pickle_protocol: int, try_json_dump: bool):
    """
    Preprocesses and converts the data to bytes for hashing.
    """
    if try_json_dump:
        try:
            data = json.dumps(data).encode("utf-8")
        except TypeError:
            pass

    type_data = type(data)

    if type_data is bytes:
        return data
    elif type_data is str:
        return data.encode("utf-8")
    elif type_data is int:
        return data.to_bytes((data.bit_length() + 8) // 8, byteorder="big", signed=True)
    elif type_data is float:
        return struct.pack("!d", data)
    else:
        _data = pickle.dumps(data, protocol=pickle_protocol)
        return pickletools.optimize(_data)

# %% nbs/netrun/01_iutils/01_hashing.ipynb 6
def adler32(bdata: bytes) -> int:
    """
    Compute portable hash for given data.
    """
    mask = 0xFFFFFFFF
    return zlib.adler32(bdata) & mask

# %% nbs/netrun/01_iutils/01_hashing.ipynb 8
def crc32(bdata: bytes) -> int:
    """
    Compute portable hash using CRC32.
    """
    mask = 0xFFFFFFFF
    return binascii.crc32(bdata) & mask

# %% nbs/netrun/01_iutils/01_hashing.ipynb 10
def sha256(bdata: bytes) -> int:
    """
    Compute hash using SHA-256.
    """
    return int.from_bytes(hashlib.sha256(bdata).digest(), byteorder="big")

# %% nbs/netrun/01_iutils/01_hashing.ipynb 12
def blake2b(bdata: bytes) -> int:
    """
    Compute hash using BLAKE2b.
    """
    return int.from_bytes(hashlib.blake2b(bdata).digest(), byteorder="big")

# %% nbs/netrun/01_iutils/01_hashing.ipynb 14
def xxh64(bdata: bytes) -> int:
    """
    Compute hash using xxHash (64-bit).
    """
    return xxhash.xxh64(bdata).intdigest()

# %% nbs/netrun/01_iutils/01_hashing.ipynb 16
class HashMethod(Enum):
    adler32 = "adler32"
    crc32 = "crc32"
    sha256 = "sha256"
    blake2b = "blake2b"
    xxh64 = "xxh64"

def hash(data: Any, method: HashMethod, pickle_protocol: int, try_json_dump: bool) -> int:
    bdata = _preprocess_data(data, pickle_protocol=pickle_protocol, try_json_dump=try_json_dump)
    if method == HashMethod.adler32:
        return adler32(bdata)
    elif method == HashMethod.crc32:
        return crc32(bdata)
    elif method == HashMethod.sha256:
        return sha256(bdata)
    elif method == HashMethod.blake2b:
        return blake2b(bdata)
    elif method == HashMethod.xxh64:
        return xxh64(bdata)
    else:
        raise ValueError(f"Invalid hash method: {method}")
